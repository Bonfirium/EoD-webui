const { PrivateKey, TransactionBuilder } = require('echojs-lib');
const { Apis } = require('echojs-ws');


const generate = () => {
	const WIDTH = 11;
	const HEIGHT = 11;

	const MONSTERS_COUNT = 1;

	const CHESTS_COUNT = 5;

	const EMPTY = 0;
	const POTENTIAL_ROOM = 1;
	const ROOM = 2;
	const WALL = 3;
	const PORTAL = 4;
	const TREASURE = 5;

	const D8_X = [1, 1, 0, -1, -1, -1, 0, 1];
	const D8_Y = [0, -1, -1, -1, 0, 1, 1, 1];
	const D8 = D8_X.map((dx, index) => ({ dx, dy: D8_Y[index] }));
	const D12_X = [2, 2, 1, 0, -1, -2, -2, -2, -1, 0, 1, 2];
	const D12_Y = [0, -1, -2, -2, -2, -1, 0, 1, 2, 2, 2, 1];
	const D12 = D12_X.map((dx, index) => ({ dx, dy: D12_Y[index] }));

	const inRange = (x, y) => x >= 0 && x < WIDTH && y >= 0 && y < HEIGHT;
	const comprehension = (count, map) =>
		new Array(count).fill(0).map((_, index) => map(index));
	const rand = (x) => Math.floor(Math.random() * x);

	const map = comprehension(WIDTH, () => comprehension(HEIGHT, () => EMPTY));
	const getVectorPoint = (x, y) => x + y * WIDTH;
	const xStart = rand(WIDTH);
	const yStart = rand(HEIGHT);
	map[xStart][yStart] = POTENTIAL_ROOM;
	const pool = [{ x: xStart, y: yStart }];

	while (pool.length) {
		const ind = rand(pool.length);
		const { x, y } = pool[ind];
		pool[ind] = pool[pool.length - 1];
		pool.pop();
		if (map[x][y] !== 1) continue;
		map[x][y] = ROOM;
		D8.forEach(({ dx, dy }) => {
			const x1 = x + dx;
			const y1 = y + dy;
			if (!inRange(x1, y1)) return;
			map[x1][y1] = WALL;
		});
		D12.forEach(({ dx, dy }) => {
			const x1 = x + dx;
			const y1 = y + dy;
			if (!inRange(x1, y1) || map[x1][y1] !== EMPTY) return;
			map[x1][y1] = POTENTIAL_ROOM;
			pool.push({ x: x1, y: y1 });
		});
	}

	const deadends = [];

	for (let x = 0; x < WIDTH; x++) {
		for (let y = 0; y < HEIGHT; y++) {
			if (map[x][y] !== ROOM) continue;
			let doorsCountGT1 = false;
			let isDeadend = true;
			for (let i = 0; i < 12; i++) {
				const x1 = x + D12_X[i];
				const y1 = y + D12_Y[i];
				if (!inRange(x1, y1) || ![ROOM, PORTAL].includes(map[x1][y1])) continue;
				if (doorsCountGT1) {
					isDeadend = false;
					break;
				}
				doorsCountGT1 = true;
			}
			if (!isDeadend || !doorsCountGT1) continue;
			deadends.push({ x, y });
			map[x][y] = PORTAL;
		}
	}

	const stepsToPortal = comprehension(WIDTH, () => comprehension(HEIGHT, () => -1));
	let prevQ = [];
	let q = [];
	let nextQ = [];
	let stepIndex = 1;
	let mainPortalPos = null;
	deadends.forEach(({ x, y }) => {
		stepsToPortal[x][y] = 0;
		q.push({ x, y });
	});
	while (true) {
		if (q.length === 0) {
			if (nextQ.length === 0) {
				mainPortalPos = prevQ[rand(prevQ.length)];
				break;
			}
			stepIndex++;
			q = nextQ;
			nextQ = [];
			prevQ = [];
		}
		const { x, y } = q.pop();
		prevQ.push({ x, y });
		D12.forEach(({ dx, dy }) => {
			const x1 = x + dx;
			const y1 = y + dy;
			if (!inRange(x1, y1) || map[x1][y1] !== ROOM) return;
			const cell = stepsToPortal[x1][y1];
			if (cell !== -1 && cell < stepIndex) return;
			nextQ.push({ x: x1, y: y1 });
			stepsToPortal[x1][y1] = stepIndex;
		});
	}

	map[mainPortalPos.x][mainPortalPos.y] = PORTAL;

	console.log(map);

	const rooms = [];
	for (let x = 0; x < WIDTH; x++) {
		for (let y = 0; y < HEIGHT; y++) {
			if (map[x][y] === ROOM) rooms.push({ x, y });
		}
	}

	const treasurePositions = comprehension(CHESTS_COUNT, () => {
		const randIndex = rand(rooms.length);
		const { x, y } = rooms[randIndex];
		rooms[randIndex] = rooms[rooms.length - 1];
		rooms.pop();
		return getVectorPoint(x, y);
	});

	const monstersPositions = comprehension(MONSTERS_COUNT, () => {
		const randIndex = rand(rooms.length);
		const { x, y } = rooms[randIndex];
		rooms[randIndex] = rooms[rooms.length - 1];
		rooms.pop();
		return getVectorPoint(x, y);
	});

	const vectorMap = [];
	for (let y = 0; y < HEIGHT; y++) {
	    for (let x = 0; x < WIDTH; x++) {
			if (map[x][y] === ROOM || map[x][y] === PORTAL) {
           	    vectorMap.push(getVectorPoint(x, y));
		   }
		}
		// console.log(str);
		// console.log(str);
	}

	console.log(vectorMap);
	console.log(monstersPositions);
	console.log(treasurePositions);

	return { map: vectorMap, monstersPositions, treasurePositions };
};

const deploy = async (operation, options, privateKey) => {

	const instance = Apis.instance(
		'wss://echo-devnet-node.pixelplex.io/ws',
		true,
		4000,
		{ enableCrypto: false },
	);

	await instance.init_promise;

	privateKey = PrivateKey.fromWif(privateKey);
	const tr = new TransactionBuilder();

	tr.add_type_operation(operation, options);

	await tr.set_required_fees(options.asset_id);
	tr.add_signer(privateKey);

	const res = await tr.broadcast();

	const resultId = res[0].trx.operation_results[0][1];
	const result = await Apis.instance().dbApi().exec('get_contract_result', [resultId]);

	const addressHex = result.exec_res.new_address.toString().slice(-32);
	const addressInt = `1.16.${parseInt(addressHex, 16)}`;
	console.log(addressHex);
	console.log(addressInt);
};

const privateKey = '5K5Xo4pKP8Wn5tivpJxEqVvD57XRokxkfHDercEkve7Am2QUKdo';
const registrar = '1.2.639';

const code = '60806040526003805463ffffffff191690556005805462ffffff60b860020a60ff0201191690553480156200003357600080fd5b5060405162001c6d38038062001c6d833981016040818152825160058054630100000060b860020a031916630100000033600160a060020a0316021790556101008301825260018352600919602080850191909152600a1983850152600b1960608501526000196080850152600a60a0850152600b60c0850152600c60e08501529084019390810192910190601690620000d2906000906008620003dc565b50604080516101808101825260028152600819602082015260008381036001818101830b830b9484019490945280820b820b6060840152600019908101820b820b6080840152600c1960a084015260011960c0840152600960e08401528401810b810b61010083015283810b810b610120830152838301810b900b610140820152600d610160820152620001699190600c620003dc565b50620001808484846401000000006200018a810204565b505050506200049d565b600554600090819033600160a060020a03908116630100000090920416146200021457604080517f08c379a000000000000000000000000000000000000000000000000000000000815260206004820152601b60248201527f6f6e6c792061646d696e2063616e206164642064756e67656f6e730000000000604482015290519081900360640190fd5b50506003805461ffff808216600081815260026020526040812061ffff19909416600190920190921617909255905b84518160ff161015620002fd576001826000016000878460ff168151811015156200026a57fe5b60209081029190910181015161ffff168252810191909152604001600020805460ff191691151591909117905584516001830190869060ff8416908110620002ae57fe5b60209081029091018101518254600181810185556000948552929093206010840401805461ffff9283166002600f909616959095026101000a9485029290940219909316179091550162000243565b5060005b600160ff8216101562000369578360ff8216600181106200031e57fe5b60200201516002830160ff8316600181106200033657fe5b601091828204019190066002026101000a81548161ffff021916908361ffff160217905550808060010191505062000301565b5060005b600560ff82161015620003d5578260ff8216600581106200038a57fe5b60200201516003830160ff831660058110620003a257fe5b601091828204019190066002026101000a81548161ffff021916908361ffff16021790555080806001019150506200036d565b5050505050565b600183019183908215620004675791602002820160005b838211156200043657835183826101000a81548160ff021916908360000b60ff1602179055509260200192600101602081600001049283019260010302620003f3565b8015620004655782816101000a81549060ff021916905560010160208160000104928301926001030262000436565b505b506200047592915062000479565b5090565b6200049a91905b808211156200047557805460ff1916815560010162000480565b90565b6117c080620004ad6000396000f3006080604052600436106100765763ffffffff7c01000000000000000000000000000000000000000000000000000000006000350416621c7b7d811461007b5780631ca1841c146100a15780635a8e080f146100ce578063a15c98db1461016f578063b307b7e914610227578063d392d1ce1461031c575b600080fd5b34801561008757600080fd5b5061009f62ffffff6004351661ffff60243516610331565b005b3480156100ad57600080fd5b506100b66108ee565b6040805162ffffff9092168252519081900360200190f35b3480156100da57600080fd5b506040805160206004803580820135838102808601850190965280855261009f95369593946024949385019291829185019084908082843750506040805160208181019092529598979681810196955093506001925084915083908082843750506040805160a081810190925294979695818101959450925060059150839083908082843750939650610ce395505050505050565b34801561017b57600080fd5b5061018c62ffffff60043516610f11565b60405160ff85168152602080820190859080838360005b838110156101bb5781810151838201526020016101a3565b5050505090500183600160200280838360005b838110156101e65781810151838201526020016101ce565b5050505090500182600560200280838360005b838110156102115781810151838201526020016101f9565b5050505090500194505050505060405180910390f35b34801561023357600080fd5b5061024462ffffff6004351661110a565b604051808060200185600160200280838360005b83811015610270578181015183820152602001610258565b5050505090500184600560200280838360005b8381101561029b578181015183820152602001610283565b5050505090500183600260200280838360005b838110156102c65781810151838201526020016102ae565b50505050905001828103825286818151815260200191508051906020019060200280838360005b838110156103055781810151838201526020016102ed565b505050509050019550505050505060405180910390f35b34801561032857600080fd5b506100b661145c565b600080808080808080607961ffff8a1610610396576040805160e560020a62461bcd02815260206004820152601f60248201527f746869732063656c6c206973206f757473696465206f662064756e67656f6e00604482015290519081900360640190fd5b62ffffff8a166000908152600460209081526040808320600181015461ffff6101009091048116855260028452828520908e16855292839052922054919950975060ff161515610430576040805160e560020a62461bcd02815260206004820152601160248201527f746869732063656c6c2069732077616c6c000000000000000000000000000000604482015290519081900360640190fd5b61043a8833611467565b9550600160ff8716109450846104535760018603610455565b855b9350600192506000600189015460ff16600481111561047057fe5b14156105fa5784156104cc576040805160e560020a62461bcd02815260206004820152601660248201527f6669727374207475726e206f6e6c792068756d616e7300000000000000000000604482015290519081900360640190fd5b60ff808716600090815260048a0160205260409020541615610538576040805160e560020a62461bcd02815260206004820152601d60248201527f73746172742d706f736974696f6e20697320616c726561647920736574000000604482015290519081900360640190fd5b886007890160ff86166001811061054b57fe5b60108104919091018054600f9092166002026101000a61ffff81810219909316939092169190910291909117905560ff861660009081526004890160205260409020805460ff1916600190811790915591505b600260ff831610156105db5760ff808316600090815260048a0160205260409020541615156105d057600092506105db565b60019091019061059e565b82156105f5576001888101805460ff191682805b02179055505b6108e2565b84610606576002610609565b60015b600481111561061457fe5b600189015460ff16600481111561062757fe5b1461067c576040805160e560020a62461bcd02815260206004820152601360248201527f6974206973206e6f7420796f7572207475726e00000000000000000000000000604482015290519081900360640190fd5b600160a060020a033316600090815260048901602052604090205460ff16156106ef576040805160e560020a62461bcd02815260206004820152601760248201527f796f7520776173206d6f7665642074686973207475726e000000000000000000604482015290519081900360640190fd5b84610725576007880160ff85166001811061070657fe5b601091828204019190066002029054906101000a900461ffff16610752565b6006880160ff85166001811061073757fe5b601091828204019190066002029054906101000a900461ffff165b905061075e818a6115a6565b15156107b4576040805160e560020a62461bcd02815260206004820152601d60248201527f63616e206e6f74206d6f766520746f207468697320706f736974696f6e000000604482015290519081900360640190fd5b841561085157886006890160ff8616600181106107cd57fe5b601091828204019190066002026101000a81548161ffff021916908361ffff160217905550600091505b600160ff831610156108345760ff808316600090815260048a0160205260409020541615156108295760009250610834565b6001909101906107f7565b82156105f5576001808901805460029260ff1990911690836105ef565b886007890160ff86166001811061086457fe5b601091828204019190066002026101000a81548161ffff021916908361ffff160217905550600191505b600260ff831610156108cb5760ff808316600090815260048a0160205260409020541615156108c057600092506108cb565b60019091019061088e565b82156108e2576001888101805460ff191690911790555b50505050505050505050565b60008060006108fb6116c7565b60055462ffffff166000908152600460209081526040808320600160a060020a03331684529182905282205490945060ff1615610982576040805160e560020a62461bcd02815260206004820152601060248201527f616c726561647920696e20717565756500000000000000000000000000000000604482015290519081900360640190fd5b600160a060020a03339081166000908152602086905260409020805460ff1916600117905560055460028087019177010000000000000000000000000000000000000000000000900460ff169081106109d757fe5b018054600160a060020a039290921673ffffffffffffffffffffffffffffffffffffffff199092169190911790556005805460ff7701000000000000000000000000000000000000000000000080830482166001018216810277ff000000000000000000000000000000000000000000000019909316929092179283905562ffffff8316955091041660021415610cda576005805477ff000000000000000000000000000000000000000000000019169055600380546001868101805461ffff620100009485900481166101000262ffff001990921691909117909155925491909104909116600090815260026020908152604091829020825193810180546080938102860184019094526060850184815291938593840182828015610b4457602002820191906000526020600020906000905b82829054906101000a900461ffff1661ffff1681526020019060020190602082600101049283019260010382029150808411610b0b5790505b50505091835250506040805160208082019283905290920191906002840190600190826000855b82829054906101000a900461ffff1661ffff1681526020019060020190602082600101049283019260010382029150808411610b6b5750505092845250506040805160a081019182905260209093019291506003840190600590826000855b82829054906101000a900461ffff1661ffff1681526020019060020190602082600101049283019260010382029150808411610bca5790505050505050815250509150600090505b600160ff82161015610c7a57602082015160ff821660018110610c3157fe5b60200201516006850160ff831660018110610c4857fe5b601091828204019190066002026101000a81548161ffff021916908361ffff1602179055508080600101915050610c12565b60038054600161ffff620100008084048216929092018116820263ffff00001990931692909217928390558204811691161415610cbf576003805463ffff0000191690555b6005805462ffffff8082166001011662ffffff199091161790555b50909392505050565b600554600090819033600160a060020a0390811663010000009092041614610d55576040805160e560020a62461bcd02815260206004820152601b60248201527f6f6e6c792061646d696e2063616e206164642064756e67656f6e730000000000604482015290519081900360640190fd5b50506003805461ffff808216600081815260026020526040812061ffff19909416600190920190921617909255905b84518160ff161015610e3a576001826000016000878460ff16815181101515610da957fe5b60209081029190910181015161ffff168252810191909152604001600020805460ff191691151591909117905584516001830190869060ff8416908110610dec57fe5b60209081029091018101518254600181810185556000948552929093206010840401805461ffff9283166002600f909616959095026101000a94850292909402199093161790915501610d84565b5060005b600160ff82161015610ea2578360ff821660018110610e5957fe5b60200201516002830160ff831660018110610e7057fe5b601091828204019190066002026101000a81548161ffff021916908361ffff1602179055508080600101915050610e3e565b5060005b600560ff82161015610f0a578260ff821660058110610ec157fe5b60200201516003830160ff831660058110610ed857fe5b601091828204019190066002026101000a81548161ffff021916908361ffff1602179055508080600101915050610ea6565b5050505050565b6000610f1b6116f4565b610f236116f4565b610f2b611713565b610f33611732565b62ffffff8616600090815260046020819052604091829020825160c0810190935260018101549091839160ff1690811115610f6a57fe5b6004811115610f7557fe5b81526001820154610100900461ffff1660208201526040805180820180835291909201919060028085019182845b8154600160a060020a03168152600190910190602001808311610fa35750505091835250506040805160a081019182905260209092019190600584810191826000855b825461010083900a900460ff161515815260206001928301818104948501949093039092029101808411610fe6575050509284525050604080516020808201928390529093019291506006840190600190826000855b82829054906101000a900461ffff1661ffff168152602001906002019060208260010104928301926001038202915080841161103c575050509284525050604080516020808201928390529093019291506007840190600190826000855b82829054906101000a900461ffff1661ffff168152602001906002019060208260010104928301926001038202915080841161109a575050509290935250508251929350505060048111156110eb57fe5b9450806080015193508060a00151925080606001519150509193509193565b60606111146116f4565b61111c611713565b611124611779565b61112c611732565b6111346116c7565b62ffffff8716600090815260046020819052604091829020825160c0810190935260018101549091839160ff169081111561116b57fe5b600481111561117657fe5b81526001820154610100900461ffff1660208201526040805180820180835291909201919060028085019182845b8154600160a060020a031681526001909101906020018083116111a45750505091835250506040805160a081019182905260209092019190600584810191826000855b825461010083900a900460ff1615158152602060019283018181049485019490930390920291018084116111e7575050509284525050604080516020808201928390529093019291506006840190600190826000855b82829054906101000a900461ffff1661ffff168152602001906002019060208260010104928301926001038202915080841161123d575050509284525050604080516020808201928390529093019291506007840190600190826000855b82829054906101000a900461ffff1661ffff168152602001906002019060208260010104928301926001038202915080841161129b57505050929093525050505060208181015161ffff166000908152600282526040908190208151600182018054948502820160809081019094526060820185815295975090949193859384018282801561137157602002820191906000526020600020906000905b82829054906101000a900461ffff1661ffff16815260200190600201906020826001010492830192600103820291508084116113385790505b50505091835250506040805160208082019283905290920191906002840190600190826000855b82829054906101000a900461ffff1661ffff16815260200190600201906020826001010492830192600103820291508084116113985750505092845250506040805160a081019182905260209093019291506003840190600590826000855b82829054906101000a900461ffff1661ffff16815260200190600201906020826001010492830192600103820291508084116113f7579050505050919092525050815160208301516040938401519590930151909a9299509397509295509350505050565b60055462ffffff1690565b600160a060020a038116600090815260208390526040812054819060ff161515611500576040805160e560020a62461bcd028152602060048201526024808201527f706c61796572206973206e6f7420636f6e6e656374656420746f20746869732060448201527f67616d6500000000000000000000000000000000000000000000000000000000606482015290519081900360840190fd5b5060005b600260ff8216101561154f5782600160a060020a0316846002018260ff1660028110151561152e57fe5b0154600160a060020a031614156115475780915061159f565b600101611504565b6040805160e560020a62461bcd02815260206004820152601c60248201527f6e6f742061626c6520746f2067657420706c6179657220696e64657800000000604482015290519081900360640190fd5b5092915050565b6000600b61ffff848116828106929081900491851681810691900484806115ce8487036115f4565b91506115db8386036115f4565b90506115e78282611614565b9998505050505050505050565b6000808260000b121561160c5781600003905061160f565b50805b919050565b600060ff831615801561162a57508160ff166002145b15611637575060016116c1565b8260ff16600214801561164b575060ff8216155b15611658575060016116c1565b8260ff16600114801561166e57508160ff166002145b1561167b575060016116c1565b8260ff16600214801561169157508160ff166001145b1561169e575060016116c1565b60ff83161580156116b0575060ff8216155b156116bd575060016116c1565b5060005b92915050565b60e060405190810160405280606081526020016116e26116f4565b81526020016116ef611713565b905290565b6020604051908101604052806001906020820280388339509192915050565b60a0604051908101604052806005906020820280388339509192915050565b604080516101608101825260008082526020820152908101611752611779565b815260200161175f611713565b815260200161176c6116f4565b81526020016116ef6116f4565b604080518082018252906002908290803883395091929150505600a165627a7a72305820919ad26cbea6681fb45987ebf96a81b46c99f6f6da0031da314ea08da058da57002900000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000005100000000000000000000000000000000000000000000000000000000000000190000000000000000000000000000000000000000000000000000000000000062000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000001900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000170000000000000000000000000000000000000000000000000000000000000019000000000000000000000000000000000000000000000000000000000000001f0000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000002f0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000003c00000000000000000000000000000000000000000000000000000000000000410000000000000000000000000000000000000000000000000000000000000043000000000000000000000000000000000000000000000000000000000000004900000000000000000000000000000000000000000000000000000000000000510000000000000000000000000000000000000000000000000000000000000058000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000620000000000000000000000000000000000000000000000000000000000000066000000000000000000000000000000000000000000000000000000000000006b000000000000000000000000000000000000000000000000000000000000006f00000000000000000000000000000000000000000000000000000000000000730000000000000000000000000000000000000000000000000000000000000078';
// const args = '00000000000000000000000000000000000000000000000000000000000000e00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000005100000000000000000000000000000000000000000000000000000000000000190000000000000000000000000000000000000000000000000000000000000062000000000000000000000000000000000000000000000000000000000000003c0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000001900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000001200000000000000000000000000000000000000000000000000000000000000170000000000000000000000000000000000000000000000000000000000000019000000000000000000000000000000000000000000000000000000000000001f0000000000000000000000000000000000000000000000000000000000000026000000000000000000000000000000000000000000000000000000000000002c000000000000000000000000000000000000000000000000000000000000002f0000000000000000000000000000000000000000000000000000000000000034000000000000000000000000000000000000000000000000000000000000003c00000000000000000000000000000000000000000000000000000000000000410000000000000000000000000000000000000000000000000000000000000043000000000000000000000000000000000000000000000000000000000000004900000000000000000000000000000000000000000000000000000000000000510000000000000000000000000000000000000000000000000000000000000058000000000000000000000000000000000000000000000000000000000000005e00000000000000000000000000000000000000000000000000000000000000620000000000000000000000000000000000000000000000000000000000000066000000000000000000000000000000000000000000000000000000000000006b000000000000000000000000000000000000000000000000000000000000006f00000000000000000000000000000000000000000000000000000000000000730000000000000000000000000000000000000000000000000000000000000078';

const args = ''

const options = {
	registrar,
	// receiver,
	asset_id: '1.3.0',
	value: 0,
	gasPrice: 0,
	gas: 15000000,
	code: `${code}${args}`,
};

deploy('contract', options, privateKey).then(() => { process.exit(0); }, () => { process.exit(1); });
// generate();
